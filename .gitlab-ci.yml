stages:
  - build
  - deploy

image:
  name: docker:stable

before_script:
  - apk -q --no-progress add vault
  - vault write -field=token auth/approle/login role_id=$VAULT_ROLE_ID secret_id=$VAULT_SECRET_ID >~/.vault-token

variables:
  IMAGE_ID: $CI_REGISTRY_IMAGE:$CI_PIPELINE_ID

build:image:gitlab:
  stage: build
  only:
    - master
  environment:
    name: gitlab-registry
  tags:
    - docker
  script:
    - mkdir -p /root/.docker
    - vault kv get -field=dockerconfig cisecrets/dockerconfig | base64 -d >/root/.docker/config
    - docker build --no-cache . -t $CI_REGISTRY_IMAGE:$CI_PIPELINE_ID
    - docker tag $CI_REGISTRY_IMAGE:$CI_PIPELINE_ID $CI_REGISTRY_IMAGE:latest
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - docker push $CI_REGISTRY_IMAGE:$CI_PIPELINE_ID
    - docker push $CI_REGISTRY_IMAGE:latest

deploy:image:production:
  stage: deploy
  only:
    - master
  tags:
    - docker
  script:
    - wget -qO /usr/local/bin/kubectl https://storage.googleapis.com/kubernetes-release/release/v1.18.2/bin/linux/amd64/kubectl && chmod 755 /usr/local/bin/kubectl
    - vault kv get -field=kubeconfig cisecrets/kubeconfig-wpcluster2 | base64 -d >/tmp/kubeconfig
    - kubectl --kubeconfig=/tmp/kubeconfig -n i18n set image deployment i18n i18n=$CI_REGISTRY_IMAGE:$CI_PIPELINE_ID

